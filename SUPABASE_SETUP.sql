-- ==========================================
-- REPAIRLY INDUSTRY STANDARD RBAC SETUP
-- ==========================================

-- 1. CLEANUP (CAREFUL! This drops existing auth structures if you run it)
-- drop table if exists public.user_roles cascade;
-- drop table if exists public.role_permissions cascade;
-- drop table if exists public.roles cascade;
-- drop table if exists public.permissions cascade;
-- drop table if exists public.users cascade; -- We will use this instead of 'profiles'

-- 2. ROLES TABLE
create table if not exists public.roles (
  id bigint generated by default as identity primary key,
  name text unique not null,
  description text
);

-- 3. PERMISSIONS TABLE
create table if not exists public.permissions (
  id bigint generated by default as identity primary key,
  key text unique not null,
  description text
);

-- 4. ROLE_PERMISSIONS TABLE (Many-to-Many)
create table if not exists public.role_permissions (
  role_id bigint references public.roles(id) on delete cascade,
  permission_id bigint references public.permissions(id) on delete cascade,
  primary key (role_id, permission_id)
);

-- 5. USERS TABLE (Public Profile synced with Auth)
-- This mirrors the 'auth.users' table but for public access
create table if not exists public.users (
  id uuid references auth.users on delete cascade primary key,
  email text,
  full_name text,
  avatar_url text,
  phone text,
  is_active boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()),
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- 6. USER_ROLES TABLE (The link between Users and Roles)
create table if not exists public.user_roles (
  user_id uuid references public.users(id) on delete cascade,
  role_id bigint references public.roles(id) on delete cascade,
  primary key (user_id, role_id)
);

-- 7. AUDIT LOGS (Track Admin Actions)
create table if not exists public.audit_logs (
  id bigint generated by default as identity primary key,
  user_id uuid references public.users(id),
  action text not null,
  metadata jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- 8. SECURITY (RLS)
alter table public.roles enable row level security;
alter table public.permissions enable row level security;
alter table public.role_permissions enable row level security;
alter table public.users enable row level security;
alter table public.user_roles enable row level security;
alter table public.audit_logs enable row level security;

-- Policies
create policy "Public Read Roles" on public.roles for select to authenticated using (true);
create policy "Public Read Permissions" on public.permissions for select to authenticated using (true);
create policy "Public Read Users" on public.users for select to authenticated using (true);
create policy "Users can update own profile" on public.users for update using (auth.uid() = id);

-- 9. SEED DEFAULT DATA
-- Insert Roles
insert into public.roles (name, description) values
('admin', 'Full system access'),
('manager', 'Can manage store but not system settings'),
('customer', 'Standard user access')
on conflict (name) do nothing;

-- Insert Permissions (Example)
insert into public.permissions (key, description) values
('view_dashboard', 'Can view admin dashboard'),
('manage_users', 'Can manage users'),
('manage_inventory', 'Can manage products'),
('view_reports', 'Can view financial reports')
on conflict (key) do nothing;

-- Assign Admin Permissions
insert into public.role_permissions (role_id, permission_id)
select r.id, p.id from public.roles r, public.permissions p
where r.name = 'admin'
on conflict do nothing;

-- 10. TRIGGER FOR NEW USERS
-- Automatically Create User Profile & Assign 'Customer' Role
create or replace function public.handle_new_user() 
returns trigger as $$
declare
  customer_role_id bigint;
begin
  -- 1. Create Profile
  insert into public.users (id, email, full_name, avatar_url)
  values (new.id, new.email, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url');

  -- 2. Get Customer Role ID
  select id into customer_role_id from public.roles where name = 'customer';

  -- 3. Assign Role
  if customer_role_id is not null then
    insert into public.user_roles (user_id, role_id) values (new.id, customer_role_id);
  end if;

  return new;
end;
$$ language plpgsql security definer;

-- Re-bind trigger
drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- HELPER: PROVISION ADMIN (Run this manually for your specific email)
-- 1. Get your User ID
-- select id from auth.users where email = 'your_email@gmail.com';
-- 2. Assign Admin Role (Replace UUID and Role ID)
-- insert into public.user_roles (user_id, role_id) values ('YOUR_UUID_HERE', (select id from public.roles where name = 'admin'));
